<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MandoDesk</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: 40px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { text-align: center; }
    input, select, button { padding: 8px; margin: 6px 0; width: 100%; }
    button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #0056b3; }
    .ticket { border: 1px solid #ccc; padding: 10px; border-radius: 4px; margin: 8px 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">

    // ✅ Login Component
    function Login({ onLogin }) {
      const [email, setEmail] = React.useState("");
      const [password, setPassword] = React.useState("");
      const [error, setError] = React.useState("");

      const handleLogin = async () => {
        try {
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });
          const data = await res.json();
          if (res.ok) {
            onLogin(data.user, data.token);
          } else {
            setError(data.message || "Login failed");
          }
        } catch (err) {
          setError("Server error");
        }
      };

      return (
        <div className="container">
          <h1>MandoDesk Login</h1>
          <input placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} />
          <input type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} />
          <button onClick={handleLogin}>Login</button>
          {error && <p style={{color:"red"}}>{error}</p>}
        </div>
      );
    }

    // ✅ Tickets Component (reusable)
    function Tickets({ tickets, onUpdate }) {
      return (
        <div>
          <h2>Tickets</h2>
          {tickets.map(t => (
            <div key={t._id} className="ticket">
              <p><b>{t.title}</b></p>
              <p>Status: {t.status}</p>
              {onUpdate && (
                <button onClick={()=>onUpdate(t._id)}>Mark Resolved</button>
              )}
            </div>
          ))}
        </div>
      );
    }

    // ✅ Customer Dashboard
    function CustomerDashboard({ token }) {
      const [title, setTitle] = React.useState("");
      const [tickets, setTickets] = React.useState([]);

      const fetchTickets = async () => {
        const res = await fetch("/api/tickets", { headers: { Authorization: `Bearer ${token}` } });
        setTickets(await res.json());
      };

      const createTicket = async () => {
        await fetch("/api/tickets", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify({ title })
        });
        setTitle("");
        fetchTickets();
      };

      React.useEffect(fetchTickets, []);

      return (
        <div className="container">
          <h1>Customer Dashboard</h1>
          <input placeholder="New Ticket Title" value={title} onChange={e=>setTitle(e.target.value)} />
          <button onClick={createTicket}>Create Ticket</button>
          <Tickets tickets={tickets} />
        </div>
      );
    }

    // ✅ Agent Dashboard
    function AgentDashboard({ token }) {
      const [tickets, setTickets] = React.useState([]);

      const fetchTickets = async () => {
        const res = await fetch("/api/tickets", { headers: { Authorization: `Bearer ${token}` } });
        setTickets(await res.json());
      };

      const markResolved = async (id) => {
        await fetch(`/api/tickets/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify({ status: "Resolved" })
        });
        fetchTickets();
      };

      React.useEffect(fetchTickets, []);

      return (
        <div className="container">
          <h1>Agent Dashboard</h1>
          <Tickets tickets={tickets} onUpdate={markResolved} />
        </div>
      );
    }

    // ✅ Admin Dashboard
    function AdminDashboard({ token }) {
      const [tickets, setTickets] = React.useState([]);

      const fetchTickets = async () => {
        const res = await fetch("/api/tickets", { headers: { Authorization: `Bearer ${token}` } });
        setTickets(await res.json());
      };

      React.useEffect(fetchTickets, []);

      return (
        <div className="container">
          <h1>Admin Dashboard</h1>
          <Tickets tickets={tickets} />
        </div>
      );
    }

    // ✅ Dashboard Switcher
    function Dashboard({ user, token }) {
      if (user.role === "admin") return <AdminDashboard token={token} />;
      if (user.role === "agent") return <AgentDashboard token={token} />;
      return <CustomerDashboard token={token} />;
    }

    // ✅ Root App
    function App() {
      const [user, setUser] = React.useState(null);
      const [token, setToken] = React.useState(null);

      return user && token ? (
        <Dashboard user={user} token={token} />
      ) : (
        <Login onLogin={(u,t)=>{ setUser(u); setToken(t); }} />
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
